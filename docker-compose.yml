# Local development: docker compose up

services:
  traefik:
    image: traefik:latest
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "8888:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  s3proxy:
    image: oxynozeta/s3-proxy:latest
    container_name: s3proxy
    restart: unless-stopped
    environment:
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        mkdir -p /tmp/conf
        cat > /tmp/conf/config.yml << 'EOF'
        log:
          level: info
          format: json
        server:
          port: 8080
          compress:
            enabled: true
        internalServer:
          port: 9090
        targets:
          data:
            mount:
              path:
                - /
            bucket:
              name: ${S3_BUCKET}
              prefix: ${S3_PREFIX}
              region: us-east-1
              s3Endpoint: ${S3_ENDPOINT}
              credentials:
                accessKey:
                  env: S3_ACCESS_KEY
                secretKey:
                  env: S3_SECRET_KEY
            actions:
              GET:
                enabled: true
                config:
                  disableListing: true
              HEAD:
                enabled: true
              PUT:
                enabled: false
              DELETE:
                enabled: false
        EOF
        exec /proxy/s3-proxy --config /tmp/conf
    labels:
      - "traefik.enable=true"
      # Main S3 proxy service
      - "traefik.http.routers.s3proxy.rule=PathPrefix(`/s3`)"
      - "traefik.http.routers.s3proxy.entrypoints=web"
      - "traefik.http.routers.s3proxy.service=s3proxy"
      - "traefik.http.middlewares.s3-strip.stripprefix.prefixes=/s3"
      - "traefik.http.routers.s3proxy.middlewares=s3-strip"
      - "traefik.http.services.s3proxy.loadbalancer.server.port=8080"
      # Metrics endpoint
      - "traefik.http.routers.s3proxy-metrics.rule=Path(`/s3-metrics`)"
      - "traefik.http.routers.s3proxy-metrics.entrypoints=web"
      - "traefik.http.routers.s3proxy-metrics.service=s3proxy-metrics"
      - "traefik.http.middlewares.s3-metrics-replace.replacepath.path=/metrics"
      - "traefik.http.routers.s3proxy-metrics.middlewares=s3-metrics-replace"
      - "traefik.http.services.s3proxy-metrics.loadbalancer.server.port=9090"

  stac-api:
    build:
      context: ../blatten-data-api
      dockerfile: Dockerfile
    container_name: blatten-stac-api
    restart: unless-stopped
    environment:
      - STAC_BASE_URL=${STAC_BASE_URL:-http://localhost:8888}
      - STAC_CATALOG_DIR=/app/stac
      - PORT=3000
      - RUST_LOG=info,tower_http=debug
    volumes:
      - ../blatten-data-api/stac:/app/stac:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.stac.rule=PathPrefix(`/stac`)"
      - "traefik.http.routers.stac.entrypoints=web"
      - "traefik.http.routers.stac.priority=10"
      - "traefik.http.services.stac.loadbalancer.server.port=3000"

  ui:
    image: node:22-alpine
    container_name: blatten-ui
    working_dir: /app
    volumes:
      - .:/app
      - /app/node_modules
    command: sh -c "npm install && npm run dev -- --host"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ui.rule=PathPrefix(`/`)"
      - "traefik.http.routers.ui.entrypoints=web"
      - "traefik.http.routers.ui.priority=1"
      - "traefik.http.services.ui.loadbalancer.server.port=8888"
